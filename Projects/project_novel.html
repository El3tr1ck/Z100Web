<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="../img/book.png" type="image/png">
    <title>Projeto novel: Eletrickz100</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f8ff; margin: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 100vh; padding-top: 10vh; text-align: center; }
        body.no-scroll { overflow: hidden; }
        .header-text { font-size: 20px; font-weight: bold; color: #007BFF; margin-bottom: 15px; max-width: 80%; }
        .search-container { display: flex; align-items: center; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; margin-bottom: 20px; }
        input { border: none; outline: none; padding: 8px; font-size: 16px; flex: 1; }
        button { background: #007BFF; border: none; padding: 8px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        button i { color: white; font-size: 16px; }
        .card-list { width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; }
        .card { display: flex; align-items: center; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); cursor: pointer; transition: transform 0.2s ease; }
        .card.not-clickable { cursor: not-allowed; opacity: 0.7; }
        .card:hover { transform: scale(1.03); }
        .card.not-clickable:hover { transform: none; }
        .card-icon { width: 50px; height: 50px; background: #007BFF; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: white; font-size: 24px; margin-right: 10px; }
        .card-content { flex: 1; text-align: left; }
        .card-title { font-size: 16px; font-weight: bold; }
        .card-subtitle { font-size: 14px; color: #007BFF; margin: 3px 0; display: flex; align-items: center; gap: 8px;}
        .card-date { font-size: 12px; color: gray; }
        .card-date.coming-soon { font-weight: bold; color: #333; }
        .theme-toggle { position: fixed; top: 20px; left: 20px; z-index: 1000; background: rgba(255, 255, 255, 0.9); border-radius: 50%; padding: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
        .theme-toggle button { background: none; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        .theme-toggle button i.fa-sun { color: #000; }
        body.dark-mode { background-color: #121212; color: white; }
        body.dark-mode .header-text { color: #d3d3d3; }
        body.dark-mode .card, body.dark-mode .search-container { background: #333; }
        body.dark-mode .card-date.coming-soon { color: #d3d3d3; }
        body.dark-mode .theme-toggle { background: rgba(0, 0, 0, 0.9); }
        body.dark-mode .theme-toggle button i.fa-moon { color: #fff; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 900; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; text-align: center; width: 90%; max-width: 300px; }
        body.dark-mode .modal-content { background: #333; color: white; }
        .modal-content .synopsis-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .modal-content .synopsis-text { font-size: 14px; margin-bottom: 15px; text-align: left; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .iframe-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 900; justify-content: center; align-items: center;}
        .iframe-modal-content { background: white; padding: 10px; border-radius: 8px; width: 95%; max-width: 800px; max-height: 95vh; overflow: auto; }
        body.dark-mode .iframe-modal-content { background: #333; }
        .iframe-modal-content iframe { width: 100%; height: 90vh; border: none; }
        .close-button { position: fixed; top: 20px; right: 20px; background: transparent; color: white; font-size: 24px; border: none; cursor: pointer; z-index: 1100; }
        .average-rating { font-size: 12px; color: #f0ad4e; font-weight: bold; }
        .average-rating .fa-star { margin-right: 2px; }
        .star-rating { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
        body.dark-mode .star-rating { border-top-color: #555; }
        .star-rating .stars { font-size: 28px; color: #ccc; cursor: pointer; }
        .star-rating .stars .fa-star:hover, .star-rating .stars .fa-star.selected { color: #f0ad4e; }
        .star-rating-label { font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        #login-to-rate { font-size: 13px; color: #888; margin-top: 10px; }
        body.dark-mode #login-to-rate { color: #aaa; }
        .page-footer { width: 100%; background-color: #e9ecef; margin-top: 40px; padding: 20px 0; border-top: 1px solid #ddd; }
        body.dark-mode .page-footer { background-color: #1c1c1c; border-top-color: #444; }
        .comments-section { width: 90%; max-width: 600px; margin: 0 auto; text-align: left; }
        .comments-section h3 { margin-bottom: 15px; }
        #comment-form { display: none; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        #comment-textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-family: Arial, sans-serif; resize: vertical; min-height: 60px; }
        body.dark-mode #comment-textarea { background-color: #333; border-color: #555; color: white; }
        #comment-form button { align-self: flex-end; width: auto; padding: 8px 15px; }
        #login-to-comment { display: block; text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 5px; font-size: 14px; }
        body.dark-mode #login-to-comment { background-color: #333; }
        .comment { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment img { width: 40px; height: 40px; border-radius: 50%; }
        .comment-content { flex: 1; }
        .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .comment-author { font-weight: bold; font-size: 14px; }
        .comment-date { font-size: 12px; color: #888; }
        body.dark-mode .comment-date { color: #aaa; }
        .comment-text { font-size: 14px; white-space: pre-wrap; word-wrap: break-word; }
        .comment-actions { position: relative; }
        .comment-actions button { background: none; border: none; color: #888; cursor: pointer; padding: 5px; }
        body.dark-mode .comment-actions button { color: #aaa; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 25px; background: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; overflow: hidden; }
        body.dark-mode .dropdown-menu { background: #444; }
        .dropdown-menu a { display: block; padding: 8px 12px; font-size: 13px; color: #333; text-decoration: none; cursor: pointer; }
        body.dark-mode .dropdown-menu a { color: white; }
        .dropdown-menu a:hover { background-color: #f0f0f0; }
        body.dark-mode .dropdown-menu a:hover { background-color: #555; }
    </style>
</head>
<body>
    <div class="theme-toggle">
        <button onclick="toggleTheme()" title="Alternar tema"><i id="theme-icon" class="fas fa-sun"></i></button>
    </div>
    <div class="header-text">Desfrute do projeto Novel, leia e baixe os capítulos aqui</div>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Buscar..." onkeyup="searchCards()">
        <button onclick="searchCards()"><i class="fas fa-search"></i></button>
    </div>
    <div class="card-list" id="cardList"></div>

    <div id="choiceModal" class="modal" onclick="closeChoiceModal(event)">
        <div class="modal-content">
            <div class="synopsis-title">Sinopse</div>
            <div class="synopsis-text" id="synopsisText"></div>
            <div id="starRatingSystem" class="star-rating">
                <div class="star-rating-label">Sua avaliação:</div>
                <div class="stars" id="modalStars">
                    <i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i>
                </div>
            </div>
            <div id="login-to-rate">Faça login para avaliar.</div>
            <div class="modal-buttons">
                <button onclick="openIframe()">No site</button>
                <button onclick="openDriveLink()">No Google Drive</button>
            </div>
        </div>
    </div>

    <div id="iframeModal" class="iframe-modal">
        <button class="close-button" onclick="closeIframeModal()">X</button>
        <div class="iframe-modal-content">
            <iframe id="pdfIframe" src=""></iframe>
        </div>
    </div>

    <footer class="page-footer">
        <div class="comments-section">
            <h3>Comentários</h3>
            <div id="comment-form-container">
                <p id="login-to-comment">Faça login para deixar um comentário.</p>
                <form id="comment-form">
                    <textarea id="comment-textarea" placeholder="Adicione um comentário..." required></textarea>
                    <button type="submit">Comentar</button>
                </form>
            </div>
            <div id="comments-list"></div>
        </div>
    </footer>

    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Script principal da sua página -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Apenas pegamos a instância já existente do Firebase. Não configuramos nada aqui.
            const auth = firebase.auth();
            const db = firebase.database();

            // Variáveis globais
            let currentDriveLink = '', currentIframeSrc = '', currentSynopsis = '', currentChapterId = null, currentUser = null;

            // --- FUNÇÕES DE LÓGICA (Nenhuma alteração aqui) ---
            window.toggleTheme = function() {
                document.body.classList.toggle('dark-mode');
                const icon = document.getElementById('theme-icon');
                icon.classList.toggle('fa-sun');
                icon.classList.toggle('fa-moon');
            }

            window.searchCards = function() {
                const query = document.getElementById('searchInput').value.toLowerCase();
                document.querySelectorAll('.card').forEach(card => {
                    const title = card.getAttribute('data-title') || '';
                    const chapter = card.getAttribute('data-chapter') || '';
                    card.style.display = (query === '' || title.includes(query) || chapter.includes(query)) ? 'flex' : 'none';
                });
            }
            
            window.createCardElement = function(chapterNumber, title, date, driveLink, iframeSrc, clickable, synopsis) {
                const card = document.createElement('div');
                card.className = 'card';
                if (clickable === 'disabled') card.classList.add('not-clickable');
                card.setAttribute('data-title', title.toLowerCase());
                card.setAttribute('data-chapter', chapterNumber);
                const chapterId = `chapter-${chapterNumber}`;
                if (clickable === 'enabled') {
                    card.onclick = () => showChoiceModal(driveLink, iframeSrc || driveLink.replace('/view?usp=drive_link', '/preview'), synopsis, chapterId);
                }
                card.innerHTML = `
                    <div class="card-icon"><i class="fas fa-download"></i></div>
                    <div class="card-content">
                        <div class="card-title">${title}</div>
                        <div class="card-subtitle">
                            <span>Capítulo ${chapterNumber}</span>
                            <span class="average-rating" id="rating-${chapterId}"></span>
                        </div>
                        <div class="card-date ${clickable === 'disabled' ? 'coming-soon' : ''}">
                            ${clickable === 'disabled' ? 'Em breve' : `Adicionado em ${date}`}
                        </div>
                    </div>`;
                loadAverageRating(chapterId);
                return card;
            }

            window.addCard = function(chapterNumber, title, driveLink, iframeSrc, clickable = 'enabled', synopsis = '') {
                const cardList = document.getElementById('cardList');
                if (cardList) {
                    const date = new Date().toLocaleDateString('pt-BR');
                    const cardElement = createCardElement(chapterNumber, title, date, driveLink, iframeSrc, clickable, synopsis);
                    cardList.appendChild(cardElement);
                }
            }

            window.showChoiceModal = function(driveLink, iframeSrc, synopsis, chapterId) {
                currentDriveLink = driveLink; currentIframeSrc = iframeSrc; currentSynopsis = synopsis; currentChapterId = chapterId;
                document.getElementById('synopsisText').textContent = synopsis || 'Sinopse não disponível.';
                document.getElementById('choiceModal').style.display = 'flex';
                updateStarDisplayForUser();
            }

            window.openIframe = function() { document.getElementById('iframeModal').style.display = 'flex'; document.getElementById('pdfIframe').src = currentIframeSrc; document.body.classList.add('no-scroll'); }
            window.openDriveLink = function() { window.open(currentDriveLink, '_blank'); }
            window.closeIframeModal = function() { document.getElementById('iframeModal').style.display = 'none'; document.getElementById('pdfIframe').src = ''; document.body.classList.remove('no-scroll'); }
            window.closeChoiceModal = function(event) { if (event.target === document.getElementById('choiceModal')) { event.target.style.display = 'none'; } }
            
            // --- LÓGICA DE AUTENTICAÇÃO E DADOS ---
            auth.onAuthStateChanged(user => {
                currentUser = user;
                updateUIForLoginState();
            });

            function updateUIForLoginState() {
                const isUserLoggedIn = !!currentUser;
                document.getElementById('comment-form').style.display = isUserLoggedIn ? 'flex' : 'none';
                document.getElementById('login-to-comment').style.display = isUserLoggedIn ? 'none' : 'block';
                if (document.getElementById('choiceModal').style.display === 'flex') {
                    updateStarDisplayForUser();
                }
                loadComments();
            }

            function loadAverageRating(chapterId) {
                const summaryRef = db.ref(`ratings/${chapterId}/summary`);
                summaryRef.on('value', (snapshot) => {
                    const ratingElement = document.getElementById(`rating-${chapterId}`);
                    if (!ratingElement) return;
                    if (snapshot.exists()) {
                        const { total, count } = snapshot.val();
                        const avg = (total / count).toFixed(1);
                        ratingElement.innerHTML = `<i class="fas fa-star"></i> ${avg} (${count})`;
                    } else { ratingElement.innerHTML = ''; }
                });
            }

            async function updateStarDisplayForUser() {
                const starSystem = document.getElementById('starRatingSystem');
                const loginMessage = document.getElementById('login-to-rate');
                if (currentUser) {
                    starSystem.style.display = 'block'; loginMessage.style.display = 'none';
                    const userRatingRef = db.ref(`ratings/${currentChapterId}/users/${currentUser.uid}`);
                    const snapshot = await userRatingRef.once('value');
                    setStars(snapshot.exists() ? snapshot.val() : 0);
                } else {
                    starSystem.style.display = 'none'; loginMessage.style.display = 'block';
                }
            }
            
            function setStars(rating) { document.querySelectorAll('#modalStars .fa-star').forEach(star => star.classList.toggle('selected', star.dataset.value <= rating)); }
            
            document.getElementById('modalStars').addEventListener('click', async (e) => {
                if (e.target.matches('.fa-star') && currentUser) {
                    const newRating = parseInt(e.target.dataset.value);
                    setStars(newRating);
                    const chapterRef = db.ref(`ratings/${currentChapterId}`);
                    chapterRef.transaction(data => {
                        data = data || { summary: { total: 0, count: 0 }, users: {} };
                        const oldRating = data.users?.[currentUser.uid] || 0;
                        data.summary.total = (data.summary.total || 0) - oldRating + newRating;
                        if (oldRating === 0) {
                            data.summary.count = (data.summary.count || 0) + 1;
                        }
                        data.users = data.users || {};
                        data.users[currentUser.uid] = newRating;
                        return data;
                    });
                }
            });

            document.getElementById('comment-form').addEventListener('submit', (e) => {
                e.preventDefault(); if (!currentUser) return;
                const textarea = document.getElementById('comment-textarea'); const text = textarea.value.trim();
                if (text) {
                    const commentsRef = db.ref(`comments`);
                    commentsRef.push({ 
                        text: text, 
                        userId: currentUser.uid, 
                        userName: currentUser.displayName, 
                        userPhotoURL: currentUser.photoURL, 
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        chapterId: currentChapterId // Importante para filtrar comentários por capítulo
                    });
                    textarea.value = '';
                }
            });

            function loadComments() {
                if (!currentChapterId) return; // Não carrega comentários se nenhum capítulo foi aberto
                const commentsRef = db.ref('comments').orderByChild('chapterId').equalTo(currentChapterId);
                commentsRef.on('value', (snapshot) => {
                    const commentsList = document.getElementById('comments-list'); 
                    commentsList.innerHTML = '';
                    if (snapshot.exists()) {
                        const comments = []; 
                        snapshot.forEach(child => { comments.push({ id: child.key, ...child.val() }); });
                        comments.reverse().forEach(comment => commentsList.appendChild(createCommentElement(comment.id, comment)));
                    }
                });
            }

            function createCommentElement(id, data) {
                const div = document.createElement('div'); div.className = 'comment';
                const date = new Date(data.createdAt).toLocaleString('pt-BR');
                const actionsHTML = (currentUser && currentUser.uid === data.userId) ? `<div c
